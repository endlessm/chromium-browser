<!DOCTYPE html>
<!--
Copyright 2016 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/value/chart_json_converter.html">
<link rel="import" href="/tracing/value/histogram_grouping.html">
<link rel="import" href="/tracing/value/histogram_set.html">

<script>
'use strict';

tr.b.unittest.testSuite(function() {
  test('emptyListOfScalarValues', function() {
    const charts = {
      benchmark_name: 'the.benchmark',
      label: 'the_label',
      charts: {
        mean_frame_time: {
          'http://games.yahoo.com': {
            std: 0.0,
            name: 'mean_frame_time',
            type: 'list_of_scalar_values',
            improvement_direction: 'down',
            important: true,
            units: 'ms',
            page_id: 16,
            description: 'Arithmetic mean of frame times.'
          },
          'summary': {
            std: 0.0,
            name: 'mean_frame_time',
            improvement_direction: 'down',
            important: true,
            units: 'ms',
            type: 'list_of_scalar_values',
            description: 'Arithmetic mean of frame times.'
          },
        }
      }
    };
    const histograms = new tr.v.HistogramSet();
    tr.v.ChartJsonConverter.convertChartJson(charts, histograms);
    assert.lengthOf(histograms, 1);
    const hist = [...histograms][0];
    assert.strictEqual('mean_frame_time', hist.name);
    assert.strictEqual('http://games.yahoo.com',
        tr.v.HistogramGrouping.BY_KEY.get(
            tr.v.d.RESERVED_NAMES.STORIES).callback(hist));
    assert.strictEqual('the.benchmark',
        tr.v.HistogramGrouping.BY_KEY.get(
            tr.v.d.RESERVED_NAMES.BENCHMARKS).callback(hist));
    assert.strictEqual('the_label',
        tr.v.HistogramGrouping.DISPLAY_LABEL.callback(hist));
    assert.strictEqual(0, hist.numValues);
    assert.strictEqual(tr.b.Unit.byName.timeDurationInMs_smallerIsBetter,
        hist.unit);
  });

  test('convertWithoutTIRLabel', function() {
    const charts = {
      charts: {
        mean_frame_time: {
          'http://games.yahoo.com': {
            std: 0.0,
            name: 'mean_frame_time',
            type: 'list_of_scalar_values',
            improvement_direction: 'down',
            important: true,
            values: [42],
            units: 'ms',
            page_id: 16,
            description: 'Arithmetic mean of frame times.'
          },
          'summary': {
            std: 0.0,
            name: 'mean_frame_time',
            improvement_direction: 'down',
            important: true,
            values: [
              16.693,
              16.646,
              16.918,
              16.681
            ],
            units: 'ms',
            type: 'list_of_scalar_values',
            description: 'Arithmetic mean of frame times.'
          },
        }
      }
    };
    const histograms = new tr.v.HistogramSet();
    tr.v.ChartJsonConverter.convertChartJson(charts, histograms);
    assert.lengthOf(histograms, 1);
    const hist = [...histograms][0];
    assert.strictEqual('mean_frame_time', hist.name);
    assert.strictEqual('http://games.yahoo.com',
        tr.v.HistogramGrouping.BY_KEY.get(
            tr.v.d.RESERVED_NAMES.STORIES).callback(hist));
    assert.strictEqual(42, hist.average);
    assert.strictEqual(1, hist.numValues);
    assert.strictEqual(tr.b.Unit.byName.timeDurationInMs_smallerIsBetter,
        hist.unit);
  });

  test('convertWithTIRLabel', function() {
    const charts = {
      charts: {
        'TIR-A@@value-name': {
          'story-name': {
            name: 'value-name',
            page_id: 7,
            improvement_direction: 'down',
            values: [42],
            units: 'ms',
            tir_label: 'TIR-A',
            type: 'list_of_scalar_values',
          },
          'summary': {
            name: 'value-name',
            improvement_direction: 'down',
            values: [42],
            units: 'ms',
            tir_label: 'TIR-A',
            type: 'list_of_scalar_values',
          },
        },
      },
    };
    const histograms = new tr.v.HistogramSet();
    tr.v.ChartJsonConverter.convertChartJson(charts, histograms);
    const hist = tr.b.getOnlyElement(histograms);
    assert.strictEqual('value-name', hist.name);
    assert.strictEqual(tr.b.getOnlyElement(hist.diagnostics.get(
        tr.v.d.RESERVED_NAMES.STORY_TAGS)), 'tir_label:TIR-A');
    assert.strictEqual('story-name',
        tr.v.HistogramGrouping.BY_KEY.get(
            tr.v.d.RESERVED_NAMES.STORIES).callback(hist));
    assert.strictEqual(42, hist.average);
    assert.strictEqual(1, hist.numValues);
    assert.strictEqual(tr.b.Unit.byName.timeDurationInMs_smallerIsBetter,
        hist.unit);
  });

  test('convertHistogram', function() {
    const charts = {
      charts: {
        MPArch_RWH_TabSwitchPaintDuration: {
          summary: {
            units: 'ms',
            buckets: [
              {
                high: 20,
                count: 2,
                low: 16,
              },
              {
                high: 24,
                count: 2,
                low: 20,
              }
            ],
            important: false,
            type: 'histogram',
            name: 'MPArch_RWH_TabSwitchPaintDuration',
          }
        }
      }
    };
    const histograms = new tr.v.HistogramSet();
    tr.v.ChartJsonConverter.convertChartJson(charts, histograms);
    assert.lengthOf(histograms, 1);
    const hist = [...histograms][0];
    assert.strictEqual('MPArch_RWH_TabSwitchPaintDuration', hist.name);
    assert.strictEqual('',
        tr.v.HistogramGrouping.BY_KEY.get(
            tr.v.d.RESERVED_NAMES.STORIES).callback(hist));
    assert.strictEqual(20, hist.average);
    assert.strictEqual(4, hist.numValues);
    assert.strictEqual(tr.b.Unit.byName.timeDurationInMs_smallerIsBetter,
        hist.unit);
  });
});
</script>
